USE [METROPOLEEXT]
GO
/****** Object:  StoredProcedure [dbo].[USP_ATUALIZA_STATUS_MENSAGERIA_30_DIAS]    Script Date: 09/11/2021 16:42:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- EXEC [dbo].[USP_ATUALIZA_STATUS_MENSAGERIA_30_DIAS]
ALTER PROCEDURE [dbo].[USP_ATUALIZA_STATUS_MENSAGERIA_30_DIAS]
AS
DECLARE @CONTADOR AS INT = 1
DECLARE @TOTALREGISTRO AS INT = 0

BEGIN
	SELECT
		ROW_NUMBER() OVER(ORDER BY id_mensageria ASC) AS Row,
		id_mensageria,
		id_cliente
	INTO 
		#MENSAGERIA_TEMPO
	FROM
		tbl_mensageria
	WHERE
 		DATEDIFF(DAY,data_sistema,GETDATE()) > 30
	AND id_status_mensageria IN (9,10,21,13,5) ;
END

SELECT @TOTALREGISTRO =COUNT(1) FROM #MENSAGERIA_TEMPO

WHILE(@CONTADOR <= @TOTALREGISTRO )
BEGIN
	DECLARE @ID_MENSAGERIA  AS INT = (SELECT id_mensageria FROM #MENSAGERIA_TEMPO  WHERE Row = @CONTADOR)
	DECLARE @IDCLIENTE AS INT = (SELECT id_cliente FROM #MENSAGERIA_TEMPO  WHERE Row = @CONTADOR)
			
	IF(@IDCLIENTE != 119)
		BEGIN
			PRINT @ID_MENSAGERIA
			PRINT @IDCLIENTE
			UPDATE
				tbl_mensageria
			SET
				id_status_mensageria = 19
			WHERE
				id_mensageria = @ID_MENSAGERIA;
			
			INSERT INTO 
				tbl_mensageria_historico 
			VALUES
				(@ID_MENSAGERIA,null,'BAIXA AUTOMÁTICA DO SISTEMA POR FALTA DE INTERAÇÃO DO USUÁRIO DENTRE PERÍODO DE UM MÊS',GETDATE(),'SISTEMA');
		END
	ELSE
		BEGIN
			PRINT @ID_MENSAGERIA
			PRINT @IDCLIENTE
		END
	SET @CONTADOR+=1;
END


